#!/usr/bin/env python
import sys

from clang.cindex import Index, TranslationUnit
from pprint import pprint
from blist import blist
from optparse import OptionParser, OptionGroup

class Options:
    def __init__(self):
        self.showIDs = None
        self.maxDepth = 0


class Crange:
    "Class Crange"

    def __init__(self):
        self.ast = {}
        self.opts = Options()

    def get_diag_info(self, diag):
        return { 'severity' : diag.severity,
                 'location' : diag.location,
                 'spelling' : diag.spelling,
                 'ranges' : diag.ranges,
                 'fixits' : diag.fixits }

    def get_cursor_id(self, cursor, cursor_list = []):
        if not self.opts.showIDs:
            return None
                
        if cursor is None:
            return None

        # FIXME: This is really slow. It would be nice if the index API exposed
        # something that let us hash cursors.
        for i,c in enumerate(cursor_list):
            if cursor == c:
                return i
        cursor_list.append(cursor)
        return len(cursor_list) - 1
    
    def get_info(self, node, depth=0):
        if self.opts.maxDepth is not None and depth >= self.opts.maxDepth:
            children = None
        else:
            children = [self.get_info(c, depth+1)
                        for c in node.get_children()]
 
        n = { 'id' : self.get_cursor_id(node),
              'kind' : node.kind,
              'usr' : node.get_usr(),
              'spelling' : node.spelling,
              'location' : node.location,
              'extent.start' : node.extent.start,
              'extent.end' : node.extent.end,
              'is_definition' : node.is_definition(),
              'definition id' : self.get_cursor_id(node.get_definition()),
              'children' : children }
        return n

    def generate(self, args):
        index = Index.create()
        tu = index.parse(None, args)
        nodes = self.get_info(tu.cursor)

if __name__ == '__main__':
    c=Crange()

    parser = OptionParser("usage: %prog [options] {filename} [clang-args*]")
    parser.add_option("", "--show-ids", dest="showIDs",
                      help="Don't compute cursor IDs (very slow)",
                      default=False)
    parser.add_option("", "--max-depth", dest="maxDepth",
                      help="Limit cursor expansion to depth N",
                      metavar="N", type=int, default=None)
    parser.disable_interspersed_args()
    (c.opts, args) = parser.parse_args()

    if len(args) == 0:
        parser.error('invalid number arguments')

    c.generate(args)
